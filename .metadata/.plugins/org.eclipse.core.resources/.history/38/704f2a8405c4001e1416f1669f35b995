package in.thiru.rest;

import org.springframework.http.HttpHeaders;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.reactive.function.client.WebClient;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.handler.codec.base64.Base64;

@RestController
public class WelcomeRestController {

    @GetMapping("/welcome")
    public String getMessage() {
        // Replace with the actual URL of the service hosting the /welcome endpoint
        String apiUrl = "http://localhost:1111/welcome";
        String username = "root";
        String password = "123456";

        // Create WebClient
        WebClient webClient = WebClient.builder()
                .defaultHeader(HttpHeaders.AUTHORIZATION, "Basic " + getBasicAuth(username, password))
                .build();

        // Make the HTTP GET request
        String response = webClient.get().uri(apiUrl).retrieve().bodyToMono(String.class).block();

        // Print the response
        System.out.println("Response from Welcome Service: " + response);
        return response;
    }

    private static String getBasicAuth(String username, String password) {
        String auth = username + ":" + password;
        ByteBuf encodedAuth = Base64.encode(Unpooled.copiedBuffer(auth.getBytes()));
        byte[] encodedBytes = new byte[encodedAuth.readableBytes()];
        encodedAuth.readBytes(encodedBytes);
        encodedAuth.release(); // Release the ByteBuf to avoid memory leaks
        return "Basic " + new String(encodedBytes);
    }
}
